---
import { getAuth } from 'firebase-admin/auth'
import Header from '../../components/Header.astro'
import Logo from '../../components/Logo.astro'
import RouteCard from '../../components/RouteCard.astro'
import Layout from '../../layouts/Layout.astro'
import { app } from '../../lib/firebase/server'
import { routes } from '../../lib/routes'
import LayoutRoute from '../../layouts/LayoutRoute.astro'

export const prerender = false
const auth = getAuth(app)
/* Check current session */
if (!Astro.cookies.has('__session')) {
  return Astro.redirect('/signin')
}

const sessionCookie = Astro.cookies.get('__session')?.value

if (!sessionCookie) {
  return Astro.redirect('/signin')
}
const decodedCookie = await auth.verifySessionCookie(sessionCookie)
const user = await auth.getUser(decodedCookie.uid)
if (!user.email?.match(/@routico.ec/)) {
  return Astro.redirect('/admin')
}
---

<LayoutRoute>
  <h1 class='text-2xl font-bold text-azur-800'>Lista de rutas</h1>
  <section>
    <ul class='grid grid-cols-[repeat(auto-fit,minmax(250px,350px))] gap-6'>
      {
        routes.map((route) => (
          <li>
            <a href={`/drivers/route/${route.name}`}>
              <RouteCard displayButton='true' />
            </a>
          </li>
        ))
      }
    </ul>
  </section>
</LayoutRoute>
